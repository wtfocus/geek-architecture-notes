[toc]

## 13 | 实战二（上）：如何对接口鉴权这样一个功能开发做面向对象分析？

-   我打算用两节课，结合一个真实的案例，从基础的需求分析、职责划分、类的定义、交互、组装运行讲起，将最基础的面向对象分析、设计、编程的的套路给你讲清楚。

### 案例介绍和难点剖析

-   需求
    -   为了保证接口调用的安全性，我们希望设计实现一个接口调用鉴权功能，只有经过认证之后的系统才能调用我们的接口，没有认证过的系统调用我们的接口会被拒绝。

#### 1. 需求不明确

-   需求过于模糊、笼统，不够具体、细化，离落地到设计、编码还有一定的距离。 

#### 2. 缺少锻炼

-   相比单纯的业务 CRUD 开发，鉴权这个开发任务，要更有难度。
-   鉴权作为一个跟具体业务无关的功能，我们完全可以把它开发成一个独立的框架，集成到很多业务系统中。而作为被很多系统利用的通过框架，比起普通的业务代码，我们对框架的代码质量要求要更高。

### 对案例进行需求分析

-   从最简单的方案想起，然后再优化。

#### 1. 第一轮基础分析

-   通过用户名和密码来做认证。

#### 2. 第二轮分析优化

-   借助加密算法，对密码进行加密之后，再传递到微服务端验证。 -- 其实也不是很安全。
-   借助 OAuth 的验证思路来解决。
    -   调用方将请求接口的 URL 跟 AppID、密码拼接在一起，然后进行加密，生成一个 token。随 URL 一块传递给微服务端。
    -   微服务端接收到这些数据后，通过同样的 token 生成算法，生成另一个 token。用这个 token 跟调用方传递过来的 token 对比。
    -   ![img](/Users/wangtao/playcrab/learn/geek-notes/设计模式之美/imgs/b79c33b0cecc93f60dc1aff15e02be39-20191219232926622.jpg)

#### 3. 第三轮分析优化

-   上面设计仍然存在**重放攻击的风险**，还是不够安全。
-   我们进一步优化 token 生成算法，引入一个随机变量，让每次接口请求生成的 token 都不一样。
    -   我们可以**选用时间戳作为随机变量**。一起加密生成 token，随 URL 一并传递给微服务端。
    -   微服务端在收到这些数据后，验证时间戳，是否在一定时间窗口内（如一分钟）。如果超过，则判定 token 过期，拒绝请求。在服务端生成新的 token，与调用方传递过来的 token 对比，看是否一致。如果一致，则允许接口调用。
-   优化后认证流程图，如下
    -   ![img](/Users/wangtao/playcrab/learn/geek-notes/设计模式之美/imgs/99c36cc37a7b36716b1d8baea7cb7bb0.jpg)

#### 4. 第四轮分析优化

-   这样还是不够安全。未认证的系统还是可以在这一分钟的 token 失效窗口内，通过截获请求，重放请求，来调用我们的接口。
-   但，权衡安全性、开发成本，对系统性能的影响，这个方案算是比较折中、比较合理的了。

#### 5. 最终确定需求

-   最终需求文字描述的文字版本
    1.  调用方进行接口请求的时候，将 URL、AppID、密码、时间戳拼接在一起，通过加密算法生成 token，并且将 token、AppID、时间戳拼接在 URL 中， 一并发送到微服务端。
    2.  微服务端在接收到接口请求后，从请求中拆解出 token、AppID、时间戳。
    3.  微服务端，首先检查传递过来的时间戳跟当前时间，是否在 token 失效时间窗口内。如果已经超过失效时间，那就算接口调用鉴权失败，拒绝接口调用请求。
    4.  如果token 验证没有过期失效，微服务再从自己存储中，取出 AppID 对应的密码，通过同步的 token 生成算法，生成另一个 token，与调用方传递过来的 token 进行匹配；如果一致，则鉴权成功，允许接口调用，否则就拒绝接口调用。