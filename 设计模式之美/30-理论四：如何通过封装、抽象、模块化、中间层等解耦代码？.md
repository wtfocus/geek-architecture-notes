[toc]

## 30 | 理论四：如何通过封装、抽象、模块化、中间层等解耦代码？

-   对于大型重构来说，我们今天重点讲解最有效的一个手段 —— “**解耦**”。解耦的目的是实现代码的高内聚、松耦合。

### “解耦”为何如此重要？

-   软件设计与开发最重要的工作之一就是应对复杂性。那如何来控制代码的复杂性呢？我认为，**最关键的就是解耦，保证代码松耦合、高内聚。**
-   实际上，“高内聚、松耦合”是一个比较通用的设计思想，不仅可以指导细粒度的类和类之间的关系的设计，还能指导粗粒度的系统、架构、模块的设计。

### 代码是否需要“解耦”？

-   间接的衡量标准有很多，如
    1.  看修改代码会不会牵一发而动全身。
    2.  模块与模块、类与类间的依赖关系是否复杂。

### 如何给代码“解耦”？

#### 1. 封装与抽象

-   封装与抽象作为两个非常通用的设计思想，可以应用在很多设计场景中。
-   封闭和抽象可以有效的隐藏实现的复杂性，隔离实现的易变性，给依赖的模块提供稳定且易用的抽象接口。

#### 2. 中间层

-   引入中间层能简化模块或类之间的依赖关系。如下是引入前后的依赖关系对比图。
    -   ![img](imgs/cbcefa78026fd1d0cb9837dde9adae52.jpg)
-   在进行重构的时候，引入中间层可以起到过渡的作用，能够让开发和重构同步进行，不互相干扰。我们可以分下面四个阶段来完成接口的修改：
    -   第一阶段：引入一个中间层，包裹老的接口，提供新的接口定义。
    -   第二阶段：新开发的代码依赖中间层提供的新接口。
    -   第三阶段：将依赖老接口的代码改为调用新接口。
    -   第四阶段：确保所有的代码都调用新接口之后，删除掉老的接口。

#### 3. 模块化

-   模块化是构建复杂系统常用的手段。
-   合理划分模块能有效地解耦代码，提高代码的可读性和可维护性。
-   实际上，模块化思想无处不在。追本溯源，模块化思想更加本质的东西就是分而治之。

#### 4. 其他设计思想和原则

-   前面讲的很多设计原则都以实现代码“高内聚、松耦合”为目的。如：

    -   单一职责原则

        >   实现高内聚的重要指导原则就是单一职责原则。

    -   基于接口而非实现编程

        >   基于接口非而实现编程通过接口这样一个中间层，隔离变化和具体实现。
        >
        >   这样，在依赖关系的两个模块或类之间，一个模块或类的改动，不会影响另一个模块或类。

    -   依赖注入

        >   跟基于接口而非实现编程思想类似，依赖注入也是将代码之间的强耦合变为弱耦合。

    -   多用组合少用继承

        >   跟继承相反，组合关系是一种弱依赖关系，这种关系更加灵活，所以，对于继承结构比较复杂的代码，利用组合来替换继承，也是一种解耦的有效手段。

    -   迪米特法则

        >   迪米特法则讲：不该有直接依赖关系的类之间，不要有依赖; 有依赖关系的类之间，尽量只依赖必要的接口。
        >
        >   这条原则的目的就是为了实现代码的松耦合。

### 重点回顾



